<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>香港 3D 巴士 Mini Tokyo</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<style>
  html, body { margin:0; padding:0; height:100%; width:100%; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #mapStyleBtn {
    position:absolute; top:10px; left:10px; z-index:10;
    padding:8px 12px; background:white; border:none; border-radius:5px; cursor:pointer;
  }
  #routeInfo {
    position:absolute; top:50px; left:10px; z-index:10;
    background:white; padding:8px 12px; border-radius:5px;
    max-width:300px;
  }
</style>
</head>
<body>
<div id="map"></div>
<button id="mapStyleBtn">切換地圖風格</button>
<div id="routeInfo">點擊巴士顯示路線資訊</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
// ---------------- Mapbox 初始化 ----------------
mapboxgl.accessToken = 'pk.eyJ1IjoibmFuNm9rIiwiYSI6ImNtazB2bTYxMTdhNnkzZHB1cXN4bTRmb3UifQ.c6BNgPAE-3qtewe22CGvyQ';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [114.157, 22.285],
  zoom: 15,
  pitch: 60,
  bearing: -17,
  antialias: true
});

// ---------------- 3D 建築 ----------------
map.on('load', () => {
  const layers = map.getStyle().layers;
  const labelLayerId = layers.find(layer => layer.type === 'symbol').id;
  map.addLayer({
    'id': '3d-buildings',
    'source': 'composite',
    'source-layer': 'building',
    'filter': ['==','extrude','true'],
    'type': 'fill-extrusion',
    'minzoom': 15,
    'paint': {
      'fill-extrusion-color': '#aaa',
      'fill-extrusion-height': ['get','height'],
      'fill-extrusion-base': ['get','min_height'],
      'fill-extrusion-opacity': 0.6
    }
  }, labelLayerId);
});

// ---------------- Three.js 初始化 ----------------
let threeScene, threeCamera, threeRenderer;
const Bus3DMarkers = {};

function initThreeLayer() {
  threeScene = new THREE.Scene();
  threeCamera = new THREE.PerspectiveCamera();
  map.addLayer({
    id: '3d-bus-layer',
    type: 'custom',
    renderingMode: '3d',
    onAdd: function(map, gl) {
      threeRenderer = new THREE.WebGLRenderer({ canvas: map.getCanvas(), context: gl, antialias:true });
      threeRenderer.autoClear = false;
    },
    render: function(gl, matrix) {
      const m = new THREE.Matrix4().fromArray(matrix);
      threeCamera.projectionMatrix = m;
      threeRenderer.state.reset();
      threeRenderer.render(threeScene, threeCamera);
      map.triggerRepaint();
    }
  });
}

// ---------------- 加載 .glb 巴士 ----------------
function addBusModel(busKey, brand, route, glbPath){
  const loader = new THREE.GLTFLoader();
  loader.load(glbPath, (gltf)=>{
    const bus = gltf.scene;
    bus.scale.set(0.002,0.002,0.002);
    bus.userData = {brand:brand, route:route};
    const start = route[0];
    const coords = mapboxgl.MercatorCoordinate.fromLngLat({lng:start.lng,lat:start.lat},0);
    bus.position.set(coords.x,coords.y,coords.z);
    Bus3DMarkers[busKey] = bus;
    threeScene.add(bus);
  });
}

// ---------------- 動態移動 ----------------
function updateBuses(){
  const now = Date.now()/1000;
  Object.values(Bus3DMarkers).forEach(bus=>{
    const route = bus.userData.route;
    if(!route) return;
    const t = (now % route.length);
    const i0 = Math.floor(t);
    const i1 = (i0+1)%route.length;
    const ratio = t - i0;
    const p0 = route[i0];
    const p1 = route[i1];
    const lng = p0.lng + (p1.lng - p0.lng)*ratio;
    const lat = p0.lat + (p1.lat - p0.lat)*ratio;
    const coords = mapboxgl.MercatorCoordinate.fromLngLat({lng,lat},0);
    bus.position.set(coords.x,coords.y,coords.z);
    bus.rotation.y = Math.atan2(p1.lng-p0.lng, p1.lat-p0.lat);
  });
}
setInterval(updateBuses,1000);

// ---------------- 點擊顯示路線 ----------------
map.on('click',(e)=>{
  const mouse = new THREE.Vector2();
  mouse.x = (e.point.x/map.getCanvas().width)*2-1;
  mouse.y = -(e.point.y/map.getCanvas().height)*2+1;
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, threeCamera);
  const intersects = raycaster.intersectObjects(Object.values(Bus3DMarkers));
  if(intersects.length>0){
    const bus = intersects[0].object;
    const info = document.getElementById('routeInfo');
    info.innerHTML = `品牌: ${bus.userData.brand.toUpperCase()}<br>
                      路線: ${bus.userData.route.map(p=>`[${p.lng.toFixed(3)},${p.lat.toFixed(3)}]`).join(' → ')}`;
  }
});

// ---------------- 初始化巴士 ----------------
map.on('load',()=>{
  initThreeLayer();
  const routeKMB = [{lng:114.157,lat:22.285},{lng:114.158,lat:22.286},{lng:114.159,lat:22.287}];
  const routeCTB = [{lng:114.158,lat:22.284},{lng:114.159,lat:22.285},{lng:114.16,lat:22.286}];
  const routeNLB = [{lng:114.156,lat:22.284},{lng:114.157,lat:22.283},{lng:114.158,lat:22.284}];

  addBusModel('KMB-1','kmb',routeKMB,'glb/kmb.glb');
  addBusModel('CTB-2','ctb',routeCTB,'glb/ctb.glb');
  addBusModel('NLB-3','nlb',routeNLB,'glb/nlb.glb');
});

// ---------------- 切換地圖風格 ----------------
document.getElementById('mapStyleBtn').addEventListener('click',()=>{
  const current = map.getStyle().name;
  if(current==='Mapbox Light') map.setStyle('mapbox://styles/mapbox/dark-v11');
  else map.setStyle('mapbox://styles/mapbox/light-v11');
});
</script>
</body>
</html>
